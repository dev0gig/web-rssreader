<!DOCTYPE html>
<html lang="de" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSS Reader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Georgia&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.1/dist/cdn.min.js" defer></script>
    <style>
        :root {
            --bg-color: #171717;
            --text-color: #fafafa;
            --text-color-light: #a3a3a3;
            --card-bg: #262626;
            --border-color: #404040;
            --accent-color: #7c3aed;
            --accent-color-hover: #8b5cf6;
            --favorite-color: #facc15;
            --reader-font-size: 20px;
        }

        body {
            font-family: 'Ubuntu', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loader {
            border: 4px solid rgba(124, 58, 237, 0.2);
            border-left-color: var(--accent-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-color);
        }

        ::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 10px;
            border: 3px solid var(--bg-color);
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: var(--text-color-light);
        }

        .visited-title {
            color: var(--text-color-light);
            opacity: 0.7;
        }

        .visited-title:hover {
            color: var(--accent-color);
            opacity: 1;
        }

        .sidebar-item-active {
            background-color: var(--accent-color);
        }

        .sidebar-item-active span,
        .sidebar-item-active .material-icons {
            color: white !important;
            font-weight: 600;
        }

        #reader-body {
            font-size: var(--reader-font-size);
            font-family: 'Georgia', serif;
        }

        #reader-body p {
            margin-bottom: 1rem;
            line-height: 1.7;
        }

        #reader-body a {
            color: var(--accent-color);
            text-decoration: underline;
        }

        #reader-body img {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }

        #reader-body-image {
            display: block;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
        }

        #reader-body h1,
        #reader-body h2,
        #reader-body h3,
        #reader-body h4 {
            font-weight: bold;
            margin: 1.5rem 0 1rem;
        }

        #reader-body ul,
        #reader-body ol {
            padding-left: 1.5rem;
            margin-bottom: 1rem;
            list-style-position: inside;
        }

        #reader-body pre {
            background-color: var(--border-color);
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        #reader-body blockquote {
            border-left: 4px solid var(--border-color);
            padding-left: 1rem;
            margin-left: 0;
            font-style: italic;
        }

        .filter-btn {
            background-color: transparent;
            color: var(--text-color-light);
            border: 1px solid var(--border-color);
        }

        .filter-btn-active {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .favorite-btn .material-icons {
            color: var(--text-color-light);
            transition: color 0.2s, transform 0.2s;
        }

        .favorite-btn:hover .material-icons {
            transform: scale(1.1);
        }

        .favorite-btn.is-favorite svg {
            fill: var(--favorite-color);
            color: var(--favorite-color);
        }

        .favorite-btn.is-favorite svg path {
            fill: var(--favorite-color);
            stroke: none;
        }

        .material-icons {
            vertical-align: middle;
        }

        .favorite-btn.is-favorite .material-icons {
            font-variation-settings: 'FILL' 1;
            color: var(--favorite-color);
        }

        [x-cloak] {
            display: none !important;
        }
    </style>
</head>

<body class="overflow-x-hidden" x-data="rssReader" x-init="init()" x-cloak @keydown.escape.window="isReaderOpen = false"
    @keydown.arrow-left.window="if(isReaderOpen) showPreviousArticle()"
    @keydown.arrow-right.window="if(isReaderOpen) showNextArticle()">
    <div class="min-h-full">
        <!-- Mobile Header -->
        <header class="lg:hidden flex justify-between items-center p-4 border-b"
            style="border-color: var(--border-color); background-color: var(--card-bg);">
            <h2 x-text="mobileFeedTitle" class="text-xl font-bold" style="color: var(--text-color);">RSS Reader</h2>
            <button @click="isMobileMenuOpen = true" class="p-2 rounded-lg">
                <span class="material-icons">menu</span>
            </button>
        </header>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 md:py-8">
            <!-- Desktop Header -->
            <header class="hidden lg:block mb-8">
                <div>
                    <h1 class="text-4xl font-bold tracking-tight" style="color: var(--text-color);">RSS Reader</h1>
                    <p class="mt-2 text-lg" style="color: var(--text-color-light);">Füge eine RSS-Feed-URL hinzu, um die
                        neuesten Beiträge anzuzeigen.</p>
                </div>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2">
                    <div class="mb-8 p-4 rounded-lg"
                        style="background-color: var(--card-bg); border: 1px solid var(--border-color);">
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input type="url" x-model="urlInput" @keypress.enter="addFeed"
                                class="flex-grow block w-full px-3 py-2 text-base rounded-md focus:outline-none focus:ring-2"
                                style="background-color: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); --tw-ring-color: var(--accent-color);"
                                placeholder="https://example.com/feed.xml">
                            <button @click="addFeed"
                                class="inline-flex items-center justify-center px-4 py-2 text-base font-medium text-white rounded-md shadow-sm transition-colors whitespace-nowrap"
                                style="background-color: var(--accent-color); border-color: transparent;"
                                onmouseover="this.style.backgroundColor='var(--accent-color-hover)'"
                                onmouseout="this.style.backgroundColor='var(--accent-color)'">
                                Feed laden
                            </button>
                        </div>
                    </div>

                    <main>
                        <div x-show="isLoading" class="flex justify-center items-center py-10 rounded-lg"
                            style="background-color: var(--card-bg); border: 1px solid var(--border-color);">
                            <div class="loader"></div>
                        </div>
                        <div x-show="message.text" x-text="message.text" class="text-center p-6 rounded-md"
                            :style="message.isError ? 'background-color: rgba(239, 68, 68, 0.1); color: #ef4444; border-color: rgba(239, 68, 68, 0.3);' : 'background-color: var(--card-bg); color: var(--text-color-light);'"
                            style="border: 1px solid var(--border-color);"></div>

                        <div x-show="!isLoading && !message.text" class="p-6 rounded-lg"
                            style="background-color: var(--card-bg); border: 1px solid var(--border-color);">
                            <!-- Feed Header -->
                            <div class="flex items-center justify-between gap-4 mb-4 pb-4 border-b"
                                style="border-color: var(--border-color);">
                                <div class="flex items-center gap-4 min-w-0">
                                    <div x-html="currentFeedIcon"></div>
                                    <h2 x-text="currentFeedTitle" class="text-2xl font-bold truncate"
                                        style="color: var(--text-color);"></h2>
                                </div>
                                <button @click="handleRefresh"
                                    class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-neutral-700 flex-shrink-0"
                                    title="Neu laden">
                                    <span class="material-icons h-6 w-6"
                                        :class="{ 'animate-spin': isRefreshing }">refresh</span>
                                </button>
                            </div>

                            <!-- Filters -->
                            <div x-show="activeView !== 'favorites'" class="flex items-center gap-2 py-4">
                                <button @click="setFilter('unread')"
                                    class="filter-btn px-3 py-1 text-sm font-semibold rounded-full transition-colors"
                                    :class="{'filter-btn-active': currentFilter === 'unread'}">
                                    Ungelesen (<span x-text="unreadCount"></span>)
                                </button>
                                <button @click="setFilter('read')"
                                    class="filter-btn px-3 py-1 text-sm font-semibold rounded-full transition-colors"
                                    :class="{'filter-btn-active': currentFilter === 'read'}">
                                    Gelesen (<span x-text="readCount"></span>)
                                </button>
                            </div>

                            <!-- Articles -->
                            <div id="articles-wrapper">
                                <template x-for="(item, index) in paginatedArticles" :key="item.link">
                                    <article class="border-b py-6 last:border-b-0 group"
                                        style="border-color: var(--border-color);">
                                        <div class="flex flex-col sm:flex-row gap-5 relative group/item">
                                            <button @click.stop="toggleFavorite(item.link)"
                                                class="favorite-btn p-2 rounded-full absolute top-3 right-2 z-10"
                                                :class="{'is-favorite': isFavorite(item.link)}"
                                                title="Als Favorit markieren">
                                                <span class="material-icons w-6 h-6">star</span>
                                            </button>
                                            <div x-show="item.imageUrl"
                                                class="sm:w-1/3 flex-shrink-0 cursor-pointer"
                                                @click="openReaderMode(getGlobalIndex(item))">
                                                <img :src="item.imageUrl"
                                                    class="w-full h-32 object-cover rounded-lg bg-neutral-200 dark:bg-neutral-700"
                                                    alt="Artikelbild" onerror="this.parentElement.style.display='none'">
                                            </div>
                                            <div class="sm:w-2/3 flex flex-col">
                                                <div class="flex-1 cursor-pointer"
                                                    @click="openReaderMode(getGlobalIndex(item))">
                                                    <h3 class="text-xl font-semibold transition-colors"
                                                        :class="isVisited(item.link) ? 'visited-title' : 'group-hover/item:text-violet-600'"
                                                        style="color: var(--text-color);" x-text="item.title"></h3>
                                                    <p class="text-sm mt-1 mb-3" style="color: var(--text-color-light);"
                                                        x-text="new Date(item.pubDate).toLocaleString('de-DE')"></p>
                                                    <p class="line-clamp-2" style="color: var(--text-color);"
                                                        x-text="item.description.substring(0, 150)"></p>
                                                    <div x-show="item.sourceTitle"
                                                        class="flex items-center gap-2 mt-3 text-xs"
                                                        style="color: var(--text-color-light);">
                                                        <img :src="item.sourceFavicon" class="w-4 h-4 rounded"
                                                            :onerror="`this.src='${placeholderFavicon}'`" />
                                                        <span x-text="item.sourceTitle"></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </article>
                                </template>
                                <p x-show="paginatedArticles.length === 0" class="text-center py-4"
                                    style="color: var(--text-color-light);" x-text="emptyStateMessage"></p>
                            </div>

                            <!-- Pagination -->
                            <div x-show="totalPages > 1"
                                class="flex justify-center items-center gap-4 mt-6 pt-4 border-t"
                                style="border-color: var(--border-color);">
                                <button @click="prevPage" :disabled="currentPage === 1"
                                    class="px-4 py-2 rounded-md shadow-sm text-white font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                    style="background-color: var(--accent-color);">Zurück</button>
                                <span class="text-sm" style="color: var(--text-color-light);"
                                    x-text="`Seite ${currentPage} / ${totalPages}`"></span>
                                <button @click="nextPage" :disabled="currentPage === totalPages"
                                    class="px-4 py-2 rounded-md shadow-sm text-white font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                    style="background-color: var(--accent-color);">Weiter</button>
                            </div>
                        </div>
                    </main>
                </div>

                <!-- Desktop Sidebar -->
                <aside class="hidden lg:block lg:col-span-1">
                    <div class="p-4 rounded-lg sticky top-8"
                        style="background-color: var(--card-bg); border: 1px solid var(--border-color);">
                        <div x-html="sidebarHtml" @click.outside="null"></div>
                    </div>
                </aside>
            </div>
        </div>
    </div>

    <!-- Mobile Sidebar -->
    <div x-show="isMobileMenuOpen" @click.away="isMobileMenuOpen = false"
        x-transition:enter="transition-opacity ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition-opacity ease-in duration-200"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70" x-cloak>
        <div x-transition:enter="transition-all ease-out duration-300"
            x-transition:enter-start="opacity-0 scale-95"
            x-transition:enter-end="opacity-100 scale-100"
            x-transition:leave="transition-all ease-in duration-200"
            x-transition:leave-start="opacity-100 scale-100"
            x-transition:leave-end="opacity-0 scale-95"
            class="relative w-full max-w-md mx-auto p-6 rounded-lg shadow-2xl" style="background-color: var(--card-bg);">
            <button @click="isMobileMenuOpen = false" class="absolute top-4 right-4 p-2 rounded-full">
                <span class="material-icons">close</span>
            </button>
            <div x-html="sidebarHtml"></div>
        </div>
    </div>

    <!-- Reader Modal -->
    <div x-show="isReaderOpen"
        x-transition:enter="transition-opacity ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition-opacity ease-in duration-200"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-75 z-50 flex justify-center items-center p-0 sm:p-4 overflow-hidden">
        <div @click.away="isReaderOpen = false" @touchstart.passive="touchStartX = $event.touches[0].clientX; touchEndX = 0"
            @touchmove.passive="touchEndX = $event.touches[0].clientX" @touchend="handleSwipe"
            x-transition:enter="transition-all ease-out duration-300" x-transition:enter-start="opacity-0 scale-95"
            x-transition:enter-end="opacity-100 scale-100" x-transition:leave="transition-all ease-in duration-200"
            x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95"
            class="relative flex flex-col h-full w-full sm:max-h-[95vh] sm:w-full sm:max-w-3xl sm:rounded-lg shadow-xl"
            style="background-color: var(--card-bg); border: 1px solid var(--border-color);">
            <button @click="showPreviousArticle" x-show="currentReaderGlobalIndex > 0"
                class="absolute left-0 sm:-left-12 top-1/2 -translate-y-1/2 p-2 rounded-full bg-black/30 hover:bg-black/50 text-white z-10 transition-opacity">
                <span class="material-icons">chevron_left</span>
            </button>
            <button @click="showNextArticle" x-show="currentReaderGlobalIndex < filteredArticles.length - 1"
                class="absolute right-0 sm:-right-12 top-1/2 -translate-y-1/2 p-2 rounded-full bg-black/30 hover:bg-black/50 text-white z-10 transition-opacity">
                <span class="material-icons">chevron_right</span>
            </button>

            <header class="relative flex-shrink-0 p-4 border-b" style="border-color: var(--border-color);">
                <button @click="isReaderOpen = false" title="Schließen"
                    class="absolute top-2 right-2 p-2 rounded-md hover:bg-gray-200 dark:hover:bg-neutral-700"
                    style="color: var(--text-color-light);">
                    <span class="material-icons">close</span>
                </button>
                <div class="flex justify-between items-start mb-2">
                    <div class="flex items-center gap-2 max-w-[calc(100%-80px)]">
                        <img x-show="readerArticle.sourceFavicon" :src="readerArticle.sourceFavicon" alt="Favicon"
                            class="w-6 h-6 rounded flex-shrink-0" :onerror="`this.style.display='none'`">
                        <h3 x-text="readerArticle.title" class="text-lg md:text-xl font-bold truncate"
                            style="color: var(--text-color);"></h3>
                    </div>
                </div>
                <div class="flex justify-between items-center">
                    <p x-text="readerArticle.sourceTitle" class="text-sm" style="color: var(--text-color-light);"></p>
                    <p x-text="`Artikel ${currentReaderGlobalIndex + 1} / ${filteredArticles.length}`" class="text-sm"
                        style="color: var(--text-color-light);"></p>
                </div>
            </header>
            <div id="reader-body" class="p-6 overflow-y-auto flex-grow" style="color: var(--text-color);"
                x-html="readerArticle.content" :style="`--reader-font-size: ${currentReaderFontSize}px`">
            </div>
            <div class="flex flex-wrap justify-center gap-2 p-4 border-t sticky bottom-0 left-0 right-0 z-10"
                style="border-color: var(--border-color); background-color: var(--card-bg);">
                <div class="flex items-center space-x-1">
                    <button @click="adjustReaderFontSize(-1)" title="Schriftgröße verkleinern"
                        class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-neutral-700"
                        style="color: var(--text-color-light);">
                        <span class="material-icons" style="font-size: 20px;">remove</span>
                    </button>
                    <button @click="adjustReaderFontSize(1)" title="Schriftgröße vergrößern"
                        class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-neutral-700"
                        style="color: var(--text-color-light);">
                        <span class="material-icons" style="font-size: 20px;">add</span>
                    </button>
                </div>
                <button @click.stop="toggleFavorite(readerArticle.link)"
                    class="favorite-btn p-2 rounded-md hover:bg-gray-200 dark:hover:bg-neutral-700"
                    :class="{'is-favorite': isFavorite(readerArticle.link)}" title="Als Favorit markieren/entfernen">
                    <span class="material-icons">star</span>
                </button>
                <a :href="readerArticle.link" target="_blank" rel="noopener noreferrer" title="Originalartikel öffnen"
                    class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-neutral-700"
                    style="color: var(--text-color-light);">
                    <span class="material-icons">open_in_new</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Import/Export Modals -->
    <div x-show="isImportModalOpen"
        x-transition:enter="transition-opacity ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition-opacity ease-in duration-200"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="fixed inset-0 bg-black bg-opacity-75 z-50 flex justify-center items-center" x-cloak>
        <div @click.away="isImportModalOpen = false"
            x-transition:enter="transition-all ease-out duration-300"
            x-transition:enter-start="opacity-0 scale-95"
            x-transition:enter-end="opacity-100 scale-100"
            x-transition:leave="transition-all ease-in duration-200"
            x-transition:leave-start="opacity-100 scale-100"
            x-transition:leave-end="opacity-0 scale-95"
            class="rounded-lg shadow-xl p-6 m-4 max-w-sm w-full"
            style="background-color: var(--card-bg); border: 1px solid var(--border-color);">
            <div class="text-center">
                <span class="material-icons mx-auto text-yellow-400" style="font-size: 48px;">warning</span>
                <h3 class="text-lg font-medium mt-2" style="color: var(--text-color);">Feeds überschreiben?</h3>
                <p class="text-sm mt-2" style="color: var(--text-color-light);">
                    Möchtest du wirklich eine neue Feed-Liste importieren? Alle deine aktuell gespeicherten Feeds,
                    Gelesen-Markierungen und Favoriten werden dabei permanent gelöscht.
                </p>
            </div>
            <div class="mt-5 sm:mt-6 grid grid-cols-2 gap-3">
                <button @click="triggerImport"
                    class="inline-flex justify-center w-full rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700">
                    Überschreiben
                </button>
                <button @click="isImportModalOpen = false"
                    class="inline-flex justify-center w-full rounded-md shadow-sm px-4 py-2 text-base font-medium"
                    style="border: 1px solid var(--border-color); background-color: var(--card-bg); color: var(--text-color);">
                    Abbrechen
                </button>
            </div>
        </div>
    </div>

    <div x-show="isExportModalOpen"
        x-transition:enter="transition-opacity ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition-opacity ease-in duration-200"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="fixed inset-0 bg-black bg-opacity-75 z-50 flex justify-center items-center" x-cloak>
        <div @click.away="isExportModalOpen = false"
            x-transition:enter="transition-all ease-out duration-300"
            x-transition:enter-start="opacity-0 scale-95"
            x-transition:enter-end="opacity-100 scale-100"
            x-transition:leave="transition-all ease-in duration-200"
            x-transition:leave-start="opacity-100 scale-100"
            x-transition:leave-end="opacity-0 scale-95"
            class="rounded-lg shadow-xl p-6 m-4 max-w-sm w-full"
            style="background-color: var(--card-bg); border: 1px solid var(--border-color);">
            <div class="text-center">
                <span class="material-icons mx-auto text-blue-400" style="font-size: 48px;">description</span>
                <h3 class="text-lg font-medium mt-2" style="color: var(--text-color);">Export-Dateiname</h3>
                <p class="text-sm mt-2" style="color: var(--text-color-light);">
                    Bitte geben Sie einen Dateinamen für den Export Ihrer RSS-Daten ein.
                </p>
                <input type="text" x-model="exportFilename"
                    class="mt-4 block w-full px-3 py-2 text-base rounded-md focus:outline-none focus:ring-2"
                    style="background-color: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); --tw-ring-color: var(--accent-color);"
                    placeholder="rss_reader_backup.json">
            </div>
            <div class="mt-5 sm:mt-6 grid grid-cols-2 gap-3">
                <button @click="performExport"
                    class="inline-flex justify-center w-full rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700">
                    Exportieren
                </button>
                <button @click="isExportModalOpen = false"
                    class="inline-flex justify-center w-full rounded-md shadow-sm px-4 py-2 text-base font-medium"
                    style="border: 1px solid var(--border-color); background-color: var(--card-bg); color: var(--text-color);">
                    Abbrechen
                </button>
            </div>
        </div>
    </div>
    <input type="file" id="import-file-input" class="hidden" accept=".json,application/json" @change="handleFileImport">

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('rssReader', () => ({
                // --- STATE ---
                savedFeeds: [],
                visitedLinks: [],
                favoriteLinks: [],
                urlInput: '',
                isLoading: true,
                isRefreshing: false,
                message: { text: '', isError: false },
                activeView: 'all', // 'all', 'favorites', or a feed URL
                currentArticles: [],
                currentFilter: 'unread', // 'all', 'read', 'unread'
                currentPage: 1,
                articlesPerPage: 10,
                isMobileMenuOpen: false,
                isReaderOpen: false,
                readerArticle: {},
                currentReaderGlobalIndex: -1,
                currentReaderFontSize: 20,
                touchStartX: 0,
                touchEndX: 0,
                isImportModalOpen: false,
                isExportModalOpen: false,
                exportFilename: '',
                placeholderFavicon: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23a3a3a3' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 12h6M7 8h6' /%3E%3C/svg%3E`,
                defaultFeeds: [
                    { url: "https://www.heise.de/rss/heise.rdf", title: "heise online News" },
                    { url: "https://static.winfuture.de/feeds/WinFuture-News-rss2.0.xml", title: "WinFuture News" },
                    { url: "https://www.hardwareluxx.de/hwl.feed", title: "Hardwareluxx RSS Feed" },
                    { url: "https://www.pcgameshardware.de/feed.cfm?menu_alias=home/", title: "PCGameshardware" },
                    { url: "https://feeds.feedburner.com/netzwelt", title: "netzwelt.de" },
                    { url: "https://feeds.feedburner.com/caschysblog", title: "Caschys Blog" },
                    { url: "https://partner-feeds.20min.ch/rss/20minuten", title: "20 Minuten | Front" },
                    { url: "https://www.derstandard.at/rss/web", title: "derStandard.at" }
                ],

                // --- COMPUTED ---
                get filteredArticles() {
                    if (this.activeView === 'favorites') {
                        return this.currentArticles.filter(item => this.isFavorite(item.link));
                    }
                    if (this.currentFilter === 'all') return this.currentArticles;
                    return this.currentArticles.filter(item => {
                        const isVisited = this.isVisited(item.link);
                        return this.currentFilter === 'unread' ? !isVisited : isVisited;
                    });
                },
                get totalPages() {
                    return Math.ceil(this.filteredArticles.length / this.articlesPerPage);
                },
                get paginatedArticles() {
                    const start = (this.currentPage - 1) * this.articlesPerPage;
                    const end = start + this.articlesPerPage;
                    return this.filteredArticles.slice(start, end);
                },
                get unreadCount() {
                    return this.currentArticles.filter(i => !this.isVisited(i.link)).length;
                },
                get readCount() {
                    return this.currentArticles.length - this.unreadCount;
                },
                get mobileFeedTitle() {
                    if (this.activeView === 'all') return 'Alle Feeds';
                    if (this.activeView === 'favorites') return 'Favoriten';
                    const feed = this.savedFeeds.find(f => f.url === this.activeView);
                    return feed ? feed.title : 'RSS Reader';
                },
                get currentFeedTitle() {
                    if (this.activeView === 'all') return 'Alle Feeds (Neueste zuerst)';
                    if (this.activeView === 'favorites') return 'Favoriten';
                    const feed = this.savedFeeds.find(f => f.url === this.activeView);
                    return feed ? feed.title : 'Feed';
                },
                get currentFeedIcon() {
                    let icon;
                    if (this.activeView === 'all') {
                        icon = 'book-open';
                    } else if (this.activeView === 'favorites') {
                        icon = 'star';
                    } else {
                        const feed = this.savedFeeds.find(f => f.url === this.activeView);
                        if (feed) {
                            return `<img src="${feed.favicon}" alt="Favicon" class="w-8 h-8 rounded flex-shrink-0" onerror="this.src='${this.placeholderFavicon}'">`;
                        }
                    }
                    let materialIcon = icon === 'book-open' ? 'menu_book' : 'star';
                    return `<span class="material-icons" style="color: var(--accent-color); font-size: 32px;">${materialIcon}</span>`;
                },
                get emptyStateMessage() {
                    if (this.activeView === 'favorites' && this.filteredArticles.length === 0) {
                        return 'Du hast noch keine Favoriten markiert.';
                    }
                    if (this.filteredArticles.length === 0) {
                        return `Keine ${this.currentFilter === 'unread' ? 'ungelesenen' : 'gelesenen'} Artikel in dieser Ansicht.`;
                    }
                    return '';
                },
                get sidebarHtml() {
                    const defaultUrls = new Set(this.defaultFeeds.map(f => f.url));
                    const feedsHtml = this.savedFeeds.length === 0
                        ? `<p class="text-sm p-2" style="color: var(--text-color-light);">Noch keine Feeds gespeichert.</p>`
                        : this.savedFeeds.map((feed, index) => {
                            const isDefault = defaultUrls.has(feed.url);
                            const deleteBtn = isDefault ? '' : `<button @click.stop.prevent="deleteFeed(${index})" class="delete-btn flex-shrink-0 ml-2 p-1 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><span class="material-icons" style="font-size: 20px;">delete</span></button>`;
                            return `
                            <div @click="loadFeed('${feed.url}')" class="flex items-center justify-between p-2 rounded-md hover:bg-gray-500/10 cursor-pointer group" :class="{'sidebar-item-active': activeView === '${feed.url}'}">
                                <div class="flex items-center gap-3 truncate">
                                    <img src="${feed.favicon}" alt="Favicon" class="w-5 h-5 rounded flex-shrink-0" onerror="this.src='${this.placeholderFavicon}'">
                                    <span class="font-medium truncate group-hover:text-violet-600" style="color: var(--text-color);">${feed.title}</span>
                                </div>
                                ${deleteBtn}
                            </div>`;
                        }).join('');

                    const html = `
                        <h2 class="text-xl font-bold mb-2" style="color: var(--text-color);">Gespeicherte Feeds</h2>
                        <div class="border-t border-b my-2 py-2" style="border-color: var(--border-color);">
                            <button @click="loadAllFeeds" class="w-full flex items-center gap-3 p-2 rounded-md hover:bg-gray-500/10 cursor-pointer group" :class="{'sidebar-item-active': activeView === 'all'}"><span class="material-icons group-hover:text-violet-600" style="color: var(--text-color-light); font-size: 20px;">menu_book</span><span class="font-medium group-hover:text-violet-600" style="color: var(--text-color);">Alle Feeds anzeigen</span></button>
                            <button @click="loadFavorites" class="w-full flex items-center gap-3 p-2 rounded-md hover:bg-gray-500/10 cursor-pointer group" :class="{'sidebar-item-active': activeView === 'favorites'}"><span class="material-icons group-hover:text-violet-600" style="color: var(--text-color-light); font-size: 20px;">star</span><span class="font-medium group-hover:text-violet-600" style="color: var(--text-color);">Favoriten (<span x-text="favoriteLinks.length"></span>)</span></button>
                        </div>
                        <div class="border-b my-2 py-2" style="border-color: var(--border-color);">
                            <button @click="isImportModalOpen = true" class="w-full flex items-center gap-3 p-2 rounded-md hover:bg-gray-500/10 cursor-pointer group"><span class="material-icons group-hover:text-violet-600" style="color: var(--text-color-light); font-size: 20px;">file_download</span><span class="font-medium group-hover:text-violet-600" style="color: var(--text-color);">Feeds importieren</span></button>
                            <button @click="handleExportClick" class="w-full flex items-center gap-3 p-2 rounded-md hover:bg-gray-500/10 cursor-pointer group"><span class="material-icons group-hover:text-violet-600" style="color: var(--text-color-light); font-size: 20px;">file_upload</span><span class="font-medium group-hover:text-violet-600" style="color: var(--text-color);">Feeds exportieren</span></button>
                        </div>
                        <div class="max-h-[50vh] overflow-y-auto pr-2">${feedsHtml}</div>`;

                    return html;
                },

                // --- METHODS ---
                init() {
                    this.loadState();
                    this.loadAllFeeds();
                    this.currentReaderFontSize = parseFloat(localStorage.getItem('readerFontSize') || 20.0);

                },
                loadState() {
                    let feeds = JSON.parse(localStorage.getItem('savedRssFeeds'));
                    if (!feeds) {
                        feeds = this.defaultFeeds.map(feed => ({ ...feed, favicon: this.getFaviconUrl(feed.url) }));
                    }
                    this.savedFeeds = feeds;
                    this.visitedLinks = JSON.parse(localStorage.getItem('rssVisitedLinks')) || [];
                    this.favoriteLinks = JSON.parse(localStorage.getItem('rssFavoriteLinks')) || [];
                    this.saveState();
                },
                saveState() {
                    localStorage.setItem('savedRssFeeds', JSON.stringify(this.savedFeeds));
                    localStorage.setItem('rssVisitedLinks', JSON.stringify(this.visitedLinks));
                    localStorage.setItem('rssFavoriteLinks', JSON.stringify(this.favoriteLinks));
                    localStorage.setItem('readerFontSize', this.currentReaderFontSize);
                },
                getFaviconUrl(url) {
                    try {
                        const domain = new URL(url).hostname;
                        return `https://www.google.com/s2/favicons?domain=${domain}&sz=32`;
                    } catch (e) {
                        return this.placeholderFavicon;
                    }
                },
                async fetchArticles(urls) {
                    this.isRefreshing = true;
                    const fetchPromises = urls.map(url => {
                        const apiUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}&_=${new Date().getTime()}`;
                        return fetch(apiUrl).then(res => res.json());
                    });

                    const results = await Promise.allSettled(fetchPromises);
                    let allItems = [];
                    results.forEach((result, index) => {
                        if (result.status === 'fulfilled' && result.value.status === 'ok') {
                            const feedInfo = this.savedFeeds.find(f => f.url === urls[index]);
                            const items = result.value.items.map(item => ({
                                ...item,
                                description: new DOMParser().parseFromString(item.description, 'text/html').body.textContent || '',
                                imageUrl: this.findImageInFeedItem(item),
                                sourceTitle: feedInfo.title,
                                sourceFavicon: feedInfo.favicon,
                                sourceUrl: feedInfo.url
                            }));
                            allItems.push(...items);
                        } else {
                            this.setTemporaryMessage(`Fehler beim Laden von ${urls[index]}`, true);
                        }
                    });
                    this.isRefreshing = false;
                    return allItems.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));
                },
                findImageInFeedItem(item) {
                    if (item.thumbnail && typeof item.thumbnail === 'string' && item.thumbnail.startsWith('http')) return item.thumbnail;
                    if (item.enclosure && item.enclosure.link && item.enclosure.type && item.enclosure.type.startsWith('image')) return item.enclosure.link;
                    const content = item.description || item.content || '';
                    const match = content.match(/<img[^>]+src="([^">]+)"/);
                    return match ? match[1] : null;
                },
                async addFeed() {
                    if (!this.urlInput.trim()) return;
                    const url = this.urlInput.trim();
                    this.urlInput = '';
                    this.isLoading = true;
                    this.message.text = '';
                    const apiUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}`;
                    try {
                        const res = await fetch(apiUrl);
                        const data = await res.json();
                        if (data.status === 'ok') {
                            if (!this.savedFeeds.some(f => f.url === url)) {
                                this.savedFeeds.unshift({ url: url, title: data.feed.title, favicon: this.getFaviconUrl(url) });
                                this.saveState();
                            }
                            this.loadFeed(url);
                        } else {
                            this.setTemporaryMessage(`Fehler: ${data.message}`, true);
                            this.isLoading = false;
                        }
                    } catch (error) {
                        this.setTemporaryMessage('Netzwerkfehler beim Hinzufügen des Feeds.', true);
                        this.isLoading = false;
                    }
                },
                deleteFeed(index) {
                    const feedUrl = this.savedFeeds[index].url;
                    this.savedFeeds.splice(index, 1);
                    this.saveState();
                    if (this.activeView === feedUrl) {
                        this.loadAllFeeds();
                    }
                },
                async loadFeed(url) {
                    this.isMobileMenuOpen = false;
                    this.isLoading = true;
                    this.message.text = '';
                    this.activeView = url;
                    this.currentFilter = 'unread';
                    this.currentPage = 1;
                    this.currentArticles = await this.fetchArticles([url]);
                    this.isLoading = false;
                },
                async loadAllFeeds() {
                    this.isMobileMenuOpen = false;
                    this.isLoading = true;
                    this.message.text = '';
                    this.activeView = 'all';
                    this.currentFilter = 'unread';
                    this.currentPage = 1;
                    const urls = this.savedFeeds.map(f => f.url);
                    this.currentArticles = await this.fetchArticles(urls);
                    this.isLoading = false;
                },
                async loadFavorites() {
                    this.isMobileMenuOpen = false;
                    this.isLoading = true;
                    this.message.text = '';
                    this.activeView = 'favorites';
                    this.currentFilter = 'all';
                    this.currentPage = 1;
                    const urls = this.savedFeeds.map(f => f.url);
                    this.currentArticles = await this.fetchArticles(urls);
                    this.isLoading = false;
                },
                handleRefresh() {
                    if (this.activeView === 'all') this.loadAllFeeds();
                    else if (this.activeView === 'favorites') this.loadFavorites();
                    else this.loadFeed(this.activeView);
                },
                setFilter(filter) {
                    this.currentFilter = filter;
                    this.currentPage = 1;
                },
                nextPage() {
                    if (this.currentPage < this.totalPages) this.currentPage++;
                },
                prevPage() {
                    if (this.currentPage > 1) this.currentPage--;
                },
                isVisited(link) {
                    return this.visitedLinks.includes(link);
                },
                isFavorite(link) {
                    return this.favoriteLinks.includes(link);
                },
                toggleFavorite(link) {
                    if (this.isFavorite(link)) {
                        this.favoriteLinks = this.favoriteLinks.filter(l => l !== link);
                    } else {
                        this.favoriteLinks.push(link);
                    }
                    this.saveState();
                },
                getGlobalIndex(item) {
                    return this.filteredArticles.findIndex(a => a.link === item.link);
                },
                openReaderMode(index) {
                    if (index === -1) return;
                    this.currentReaderGlobalIndex = index;
                    const item = this.filteredArticles[index];
                    const tempContentDiv = document.createElement('div');
                    tempContentDiv.innerHTML = item.content || item.description;
                    tempContentDiv.querySelectorAll('img').forEach(img => img.remove());
                    const articleImageUrl = this.findImageInFeedItem(item);
                    if (articleImageUrl) {
                        const imgElement = document.createElement('img');
                        imgElement.src = articleImageUrl;
                        imgElement.alt = 'Artikelbild';
                        imgElement.className = 'w-full h-auto mb-4 rounded-lg';
                        imgElement.id = 'reader-body-image';
                        tempContentDiv.appendChild(imgElement);
                    }
                    this.readerArticle = { ...item, content: tempContentDiv.innerHTML };
                    this.isReaderOpen = true;
                    if (!this.isVisited(item.link)) {
                        this.visitedLinks.push(item.link);
                        this.saveState();
                    }
                    this.$nextTick(() => {
                        document.getElementById('reader-body').scrollTop = 0;
                    });
                },
                showNextArticle() {
                    if (this.currentReaderGlobalIndex < this.filteredArticles.length - 1) {
                        this.openReaderMode(this.currentReaderGlobalIndex + 1);
                    }
                },
                showPreviousArticle() {
                    if (this.currentReaderGlobalIndex > 0) {
                        this.openReaderMode(this.currentReaderGlobalIndex - 1);
                    }
                },
                adjustReaderFontSize(increment) {
                    const newSize = this.currentReaderFontSize + increment;
                    if (newSize >= 12 && newSize <= 28) {
                        this.currentReaderFontSize = newSize;
                        this.saveState();
                    }
                },
                handleSwipe() {
                    if (!this.isReaderOpen || this.touchEndX === 0) return;
                    const swipeDistance = this.touchStartX - this.touchEndX;
                    if (Math.abs(swipeDistance) > 50) { // Minimum swipe distance
                        if (swipeDistance > 0) {
                            this.showNextArticle();
                        } else {
                            this.showPreviousArticle();
                        }
                    }
                    // Reset values to prevent accidental swipes
                    this.touchStartX = 0;
                    this.touchEndX = 0;
                },
                handleExportClick() {
                    this.exportFilename = `rss_reader_backup_${new Date().toISOString().split('T')[0]}.json`;
                    this.isExportModalOpen = true;
                },
                performExport() {
                    const exportData = {
                        feeds: this.savedFeeds.map(({ url, title }) => ({ url, title })),
                        visited: this.visitedLinks,
                        favorites: this.favoriteLinks
                    };
                    const dataStr = JSON.stringify(exportData, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = this.exportFilename.endsWith('.json') ? this.exportFilename : `${this.exportFilename}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    this.isExportModalOpen = false;
                },
                triggerImport() {
                    this.isImportModalOpen = false;
                    document.getElementById('import-file-input').click();
                },
                handleFileImport(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.feeds && data.visited && data.favorites) {
                                this.savedFeeds = data.feeds.map(f => ({ ...f, favicon: this.getFaviconUrl(f.url) }));
                                this.visitedLinks = data.visited;
                                this.favoriteLinks = data.favorites;
                                this.saveState();
                                this.loadAllFeeds();
                                this.setTemporaryMessage('Import erfolgreich!', false);
                            } else {
                                throw new Error('Invalid file format');
                            }
                        } catch (error) {
                            this.setTemporaryMessage('Import fehlgeschlagen.', true);
                        }
                    };
                    reader.readAsText(file);
                    event.target.value = '';
                },
                setTemporaryMessage(text, isError) {
                    this.message = { text, isError };
                    setTimeout(() => {
                        this.message.text = '';
                    }, 3000);
                }
            }));
        });
    </script>
</body>

</html>